<?php
/**
 * Form popup templage
 * @var $block Jellyfish\GWebinars\Block\Tracks
 */ 
$trackId = $block->getData('track_id');
$trackDetails = $block->getTrackDetails($trackId);
$trackDetails = $trackDetails[0];
$webinarList = $block->getTrackwebinars($trackId);
?>
<!--Personal learning modal-->

<span class="close-button"><span>Close</span><img src="<?php echo $this->getViewFileUrl('images/close-ico.svg'); ?>" /></span>
<?php if($webinarList['error'] == true) :
		echo "Error";
else:
?>
<span class="d-none lookup" style='display:none;'><?php echo json_encode($webinarList['lookup']); ?></span>
<input type="hidden" id="bundle-str" value='' />
<input type="hidden" id="bundle-date-str" value='' />
<div class="personal-plan__modal__content">
	<div class="personal-plan__modal__title"><?php /* escapeNotVerified*/ echo  $trackDetails['w_cat_title']; ?></div>
	<div class="personal-plan__modal__sub"><?php echo __('Google Cloud Learning path'); ?></div>
	<div class="personal-plan__modal__desc"><?php /* esscapeNotVerified */ echo __('When would you like to start the virtual classes in this path?');  ?></div>
	<div class="personal-plan__modal__grid">
		
		<div class="personal-plan__modal__trow">
			<div class="personal-plan__modal__trow--data">
				<div class="personal-plan__modal__theader personal-plan__modal__wid"><?php /* escapeNotVerified*/ echo __('Course'); ?></div>
				<div class="personal-plan__modal__theader personal-plan__modal__wid"><?php /* escapeNotVerified*/ echo __('Time Zone'); ?></div>
				<div class="personal-plan__modal__theader personal-plan__modal__wid"><?php /* escapeNotVerified*/ echo __('Date') ?></div>
			</div>
		</div> 
		<?php if(count($webinarList['timezones']) > 0) { 
			$position = 0;
			?>
			<?php foreach ($webinarList['timezones'] as $optionId => $data) { ?>
				<?php if(isset($data['timezone'])) { ?>
					<div class="personal-plan__modal__trow option-wrapper option-container-<?php echo $optionId; ?>">
						<div class="personal-plan__modal__trow--data">
							<div class="personal-plan__modal__tdata personal-plan__modal__wid">
								<div class="personal-plan__modal__tdata--head"><?php echo $data['option_title']; ?></div>
								<div class="personal-plan__modal__tdata--desc"><?php echo isset($data['option_course_duration']) ? $data['option_course_duration'] : '1 Day Classroom course'; ?></div>
							</div>
							<div class="personal-plan__modal__tdata personal-plan__modal__wid">
								<div class="personal-plan__modal__theader personal-plan__modal__wid"><?php /* escapeNotVerified*/ echo __('Time Zone') ?></div>
								<div class="personal-plan__modal__tdata--drop">								
									<select class="dropdown timezone" id="timezone[<?php echo $optionId ?>]" name="timezone[<?php echo $optionId ?>]" data-option-id="<?php echo $optionId ?>">									
                                        <option value='-1'>Select a Timezone</option>
                                        <?php  foreach($data['timezone'] as $location_id => $locationData) { ?>
												<option value="<?php echo $location_id ?>"><?php echo $locationData['title'];?></option>
										<?php } ?>
									</select>									
									<span class="d-none date-options" style='display:none;'><?php echo json_encode($data['timezone']); ?></span>										
								</div>
								
							</div>
							<div class="personal-plan__modal__tdata personal-plan__modal__wid">
								<div class="personal-plan__modal__theader personal-plan__modal__wid"><?php /* escapeNotVerified*/ echo __('Date') ?></div>
								<div class="personal-plan__modal__tdata--drop">
									<select class="dropdown date" id="timezone[<?php echo $optionId ?>]" name="timezone[<?php echo $optionId ?>]" data-option-id="<?php echo $optionId ?>" data-position="<?php echo $position++; ?>">
											<option value='-1'><?php echo __('Select an option'); ?></option>
									</select>
								</div>
							</div>
						</div>
						<div class="personal-plan__modal__trow--error"></div>
					</div>
				<?php } ?>	
			<?php } ?>
		<?php } ?>
        <div class="detail-section">
            <div class="input-fields clearfix">
                <fieldset class="form-wrapper">
                    <legend class="panel-heading">
                        <span class="panel-title fieldset-legend">What is your name and contact email?</span>
                    </legend>
                    <div class="panel-body" id="user-details-form">
                        <div class="field-type-text">
                        <input name="firstname" id="firstname" title="<?php /* @escapeNotVerified */ echo __('First name') ?>" class="input-text validate-length maximum-length-30" maxlength="30" type="text" value="" required />
                            <label class="label" for="firstname"><span><?php /* @escapeNotVerified */ echo __('First name') ?></span></label>
                            <div class="error-message"></div>
                        </div>

                        <div class="field-type-text">
                            <input name="lastname" id="lastname" title="<?php /* @escapeNotVerified */ echo __('Last name') ?>" type="text" />
                            <label class="label" for="lastname">
                                <span>
                                    <?php /* @escapeNotVerified */ echo __('Last name') ?>
                                </span>
                            </label>
                            <div class="form-error-message"></div>
                        </div>

                        <div class="field-type-text">
                            <input name="email" id="email" title="<?php /* @escapeNotVerified */ echo __('Email') ?>" class="input-text" type="text" />
                            <label class="label" for="email">
                                <span>
                                    <?php /* @escapeNotVerified */ echo __('Email') ?>
                                </span>
                            </label>
                            <div class="form-error-message"></div>
                        </div>

                        <div class="field-type-text">
                            <input name="location" id="location" title="<?php /* @escapeNotVerified */ echo __('Location') ?>" class="input-text" type="text"/>
                            <label class="label" for="location">
                                <span>
                                    <?php /* @escapeNotVerified */ echo __('Location') ?>
                                </span>
                            </label>
                            <div class="form-error-message"></div>
                        </div>  

                        <div class="field-type-text">
                            <input name="job_title" id="job_title" title="<?php /* @escapeNotVerified */ echo __('Job title (optional)') ?>" class="input-text" type="text"/>
                            <label class="label" for="job_title">
                                <span>
                                    <?php /* @escapeNotVerified */ echo __('Job title (optional)') ?>
                                </span>
                            </label>
                            <div class="form-error-message"></div>
                        </div>
                    </div>
                </fieldset>
            </div>
        </div>
	</div>

	<div class="personal-plan__modal__btn">
	    <a class="personal-plan__modal__btn--cancel" href="javascript:void(0);"><?php /*escapeNotVerified*/ echo __('Cancel'); ?></a>
	    <a href="javascript:void(0);" data-pid="23"  data-url="<?php echo "test"; ?>" class="detail__button wb-bundle-submit" id="wb-bundle-submit"><?php /*escapeNotVerified*/ echo __('Continue and add to basket'); ?></a>
	</div>
</div>
<?php endif; ?>

<script type="text/javascript">
    (function () {
        require(["jquery","jquery/validate"], function (jQuery) {
            jQuery("body").on("click", ".course_popup", function () {
                var currentCard = jQuery(this).closest(".courses__card");
                currentCard.find(".personal-plan__modal").addClass('show-personal-modal');
            });
            jQuery("body").on("click", ".wb-plp-add", function () {
                var ajaxUrl = jQuery(this).attr("data-url");
                jQuery(".personal-plan__modal").not(".courses__card .personal-plan__modal").addClass("show-personal-modal");
                jQuery.ajax({
                        'method':'GET',
                        'url' : ajaxUrl,
                        'showLoader': true,
                        'data' : 'trackid='+"<?php echo $trackId; ?>",
                    }).done(function (resp) {
                        if (resp.error == true) {
                            jQuery(".messages").show();
                            jQuery(".personal-plan__modal").removeClass(
                                "show-personal-modal plp--loader"
                            );
                            setTimeout(function () {
                                jQuery(".messages").hide("blind", {}, 500);
                            }, 5000);
                        } else {
                            jQuery(".personal-plan__modal .personal-plan--content").not(".courses__card .personal-plan__modal .personal-plan--content").html(resp.output);
                            jQuery(".personal-plan__modal").removeClass(
                                "plp--loader"
                            );
                           
                            jQuery(".timezone").on("change", function () {
                                var option_id = jQuery(this).attr("data-option-id");
                                var timezone_id = jQuery(this).val();
                                var parent = jQuery(this).parents(
                                    ".personal-plan__modal__trow--data"
                                );
                                if (timezone_id) {
                                    bindDates(option_id, timezone_id);
                                }
                                
                                updateOptionsetValue(this);
                            });

                            jQuery(".date").on("change", function () {
                                var selector =jQuery(this).parents(".option-wrapper");
                                var option = jQuery(this).find("option:selected");
                                var rawDate = jQuery(option).attr("data-raw-date");
                                jQuery(this).attr("data-raw-date", rawDate);
                               // updateOptionsetValue(this);
                                gnerateBundleOptionStr();
                                if (isValidData(selector)) {
                                    gnerateBundleOptionStr();
                                }
                            });
                        }                  
                });

                function updateOptionsetValue(element) {
                    var parent = jQuery(element).closest(".option-wrapper");
                    var date = parent.find(".date").val();
                    var timezone = parent.find(".timezone").val();
                    var optionset = parent.find(".option-set");
                  //  console.log(element);
                    if(date == -1 || date == "" || timezone == -1 || timezone == "") {
                        optionset.val(0);
                    } else {
                        optionset.val(1);
                    }
                }

                function bindDates(option_id, timezone_id) {
                    var container = jQuery(".option-container-" + option_id);
                    var locationJson = JSON.parse(
                        jQuery(container).find(".date-options").html()
                    );
                    
                    if (timezone_id !=-1) {
                        var dates = locationJson[timezone_id]["dates"];
                        var dates_array = jQuery.map(dates, function (value, index) {
                            return { raw_date: index, dt: value };
                        });
                        var dateOptions = "<option value=''>Select an option</option>";
                        jQuery(dates_array).each(function (index, value) {
                            dateOptions +=
                                "<option value='" +
                                value["dt"] +
                                "' data-raw-date='" +
                                value["raw_date"] +
                                "'>" +
                                value["dt"] +
                                "</option>";
                        });
                        jQuery(container).find(".date").html(dateOptions);
                    } else {
                        var dateOptions = "<option value=''>Select an option</option>";
                        jQuery(container).find(".date").html(dateOptions);
                    }
                }

                function isValidData(selector) {
                    var valid1 = true;
                    jQuery(selector).each(function () {
                        var msg = "";
                        var date = jQuery(this).find(".date");
                        var timezone = jQuery(this).find(".timezone");
                        if (
                            jQuery(timezone).val() == "" &&
                            jQuery(date).val() == ""
                        ) {
                            msg =
                                "Please select timezone and date to proceed further.";
                            valid1 = false;
                            jQuery(timezone).addClass("sel-error");
                            jQuery(date).addClass("sel-error");
                        } else if (jQuery(date).val() == "") {
                            msg = "Please select the date";
                            valid1 = false;
                            jQuery(date).addClass("sel-error");
                        } else if (jQuery(timezone).val() == "") {
                            msg = "Please select the timezone";
                            valid1 = false;
                            jQuery(timezone).addClass("sel-error");
                        } else {
                            msg = "";
                            valid1 = true;
                            jQuery(timezone).removeClass("sel-error");
                            jQuery(date).removeClass("sel-error");
                        }
                        jQuery(selector).removeClass("plp-error");
                        if (msg != "") {
                            jQuery(this).find(".personal-plan__modal__trow--error").html(msg);
                            jQuery(selector).addClass("plp-error");
                        }
                    });
                    return valid1;
                }

                function gnerateBundleOptionStr() {
                    var selector = jQuery(".personal-plan__modal__content .timezone");
                    var data = {};
                    data["track"] = "<?php echo $trackId; ?>";
                    data["webinars"] = [];
                    jQuery(selector).each(function () {
                        var option_id = jQuery(this).attr("data-option-id");
                        var container = jQuery(".option-container-" + option_id);
                        var timezone = jQuery(this).val();
                        var date = null;
                        date = jQuery(container).find(".date").val();
                        if (date != "" && date != -1) {
                            var filtered_data = [];
                            filtered_data = lookup(option_id, timezone, date);
                            data["webinars"].push(filtered_data[0]["webinar_id"]);
                        }
                    });
                    jQuery("#bundle-str").attr("value", JSON.stringify(data));
                }

                function lookup(option_id, timezone, date) {
                    var data = jQuery(".lookup").html();
                    data = JSON.parse(data);
                    var dataArray = Object.values(data);
                    var retVal = jQuery.grep(dataArray, function (row) {
                        return (
                            row.option_id == option_id &&
                            row.card_timezone == timezone &&
                            row.card_date == date
                        );
                    });
                    return retVal;
                }

            });
            jQuery("#user-details-form").validate({
                    errorClass: "form-error-message",
                    rules: {
                        firstname: {
                            required: true,
                            minlength: 2
                        },
                        lastname: {
                            required: true,
                            minlength: 2
                        },
                        email: {
                            required: true,
                            email: true
                        },
                        location: {
                            required: true,
                            minlength: 10
                        }
                    },
                    messages: {
                        firstname: {
                            required: "First name is required field",
                            minlength: "Your first name must be at least 2 characters long"
                        },
                        lastname: {
                            required: "Last name is required field",
                            minlength: "Your last name must be at least 2 characters long"
                        },
                        email: {
                            required: "Email is required field",
                            email: "Please enter a valid email address"
                        },
                        location: {
                            required: "Location is required field",
                            minlength: "Your phone number must be at least 10 characters long"
                        }
                    }
            });
            jQuery("body").on("click", "#wb-bundle-submit", function() {console.log("button is clicked");
                if (jQuery("#user-details-form").valid()) {console.log("Form is valid");
                    jQuery.ajax({
                            url: '<?php echo $this->getUrl("your/controller/action"); ?>', // replace with your actual URL
                            type: 'POST',
                            data: {
                                firstname: jQuery('#firstname').val(),
                                lastname: jQuery('#lastname').val(),
                                email: jQuery('#email').val(),
                                telephone: jQuery('#telephone').val(),
                                // Add any other data you want to send to the server
                            },
                            success: function(response) {
                                // Handle successful response
                                alert('Success: ' + response.message);
                            },
                            error: function(xhr, status, error) {
                                // Handle error
                                alert('Error: ' + xhr.responseText);
                            }
                    });    
                } else {
                    console.log("Form is invalid");
                }
                    
            });
                
        });
    })();
</script>
