<script type="text/javascript">
    require(['jquery', 'jquery/validate'], function($) {
        $(document).ready(function() {
            $.validator.addMethod('validate_alphanum_with_dash', function (value, element) {
                return this.optional(element) || /^[a-zA-Z -]+$/.test(value);
            }, "<?php echo $generalHelper->getNameValidationMessage(); ?>");

            var domain_values = <?php echo $allowedDomainsList; ?>;
            var allowedDomains = domain_values.map(function(domain) {
                return domain.toLowerCase();
            });

            $.validator.addMethod("valid_domain", function(value, element) {
                if (allowedDomains.length === 0) {
                    return true;
                }
                var domain = value.split('@')[1].toLowerCase();
                return this.optional(element) || allowedDomains.includes(domain);
            }, "Please enter an email address with an approved domain.");

            $("#user-details-form").validate({
                errorElement: "div", // Use <div> instead of <label> for error messages
                errorPlacement: function(error, element) {
                    error.appendTo(element.closest('.field-type-text').find('.form-error-message'));
                },
                rules: {
                    firstname: {
                        required: true,
                        minlength: 2,
                        validate_alphanum_with_dash: true
                    },
                    lastname: {
                        required: true,
                        minlength: 2,
                        validate_alphanum_with_dash: true
                    },
                    email: {
                        required: true,
                        email: true,
                        valid_domain: true
                    },
                    location: {
                        required: true,
                        minlength: 2,
                        validate_alphanum_with_dash: true
                    }
                },
                messages: {
                    firstname: {
                        required: "First name is required field.",
                        minlength: "Your first name must be at least 2 characters long.",
                        validate_alphanum_with_dash : "<?php echo $generalHelper->getNameValidationMessage(); ?>"
                    },
                    lastname: {
                        required: "Last name is required field.",
                        minlength: "Your last name must be at least 2 characters long.",
                        validate_alphanum_with_dash : "<?php echo $generalHelper->getNameValidationMessage(); ?>"
                    },
                    email: {
                        required: "Email is required field.",
                        email: "Please enter a valid email address (Ex: johndoe@domain.com).",
                        valid_domain : "Please enter an email address with an appropriate domain."
                    },
                    location: {
                        required: "Location is required field",
                        minlength: "Your location must be at least 2 characters long.",
                        validate_alphanum_with_dash : "<?php echo $generalHelper->getNameValidationMessage(); ?>"
                    }
                },
                onfocusout: false,
                onkeyup: false,
                onclick: false
            });

            function isValidData(selector) {
                var valid1 = true;
                $(selector).each(function () {
                    var msg = "";
                    var date = $(this).find(".date");
                    var timezone = $(this).find(".timezone");
                    var date_value = $(date).val();
                    var timezone_value = $(timezone).val();

                    if ((timezone_value == -1 || timezone_value == "") && (date_value == "" || date_value == -1)) {
                        msg = "Please select timezone and date to proceed further.";
                        valid1 = false;
                        $(timezone).addClass("sel-error");
                        $(date).addClass("sel-error");
                    } else if (date_value == "" || date_value == -1) {
                        msg = "Please select the date";
                        valid1 = false;
                        $(date).addClass("sel-error");
                    } else if (timezone_value == -1 || timezone_value == "") {
                        msg = "Please select the timezone";
                        valid1 = false;
                        $(timezone).addClass("sel-error");
                    } else {
                        msg = "";
                        valid1 = true;
                        $(timezone).removeClass("sel-error");
                        $(date).removeClass("sel-error");
                        $(this).find(".personal-plan__modal__trow--error").html(msg);
                    }
                    $(selector).removeClass("plp-error");
                    if (msg != "") {
                        $(this).find(".personal-plan__modal__trow--error").html(msg);
                        $(selector).addClass("plp-error");
                    }
                });
                return valid1;
            }

            $("#wb-bundle-submit").on("click", function() {
                if (isValidData($(".personal-plan__modal__content .option-wrapper")) && $("#user-details-form").valid()) {
                    $.ajax({
                        url: '<?php echo $this->getUrl("wbtracks/track/save"); ?>',
                        type: 'POST',
                        data: {
                            first_name: $('#firstname').val(),
                            last_name: $('#lastname').val(),
                            email: $('#email').val(),
                            location: $('#location').val(),
                            job_title: $('#job_title').val(), 
                            webinar_details: $("#bundle-str").val()
                        },
                        success: function(response) {
                            if (response["status"] == "success") {
                                $(".personal-plan__modal").removeClass("show-personal-modal");
                                $(".thankYou-container").css("display","block")
                            } else {
                                alert(response["message"]);
                            }
                        },
                    });
                } 
            });

            $(".personal-plan__modal__content .detail-section input").each(function () {
                blur_input_next(this);
            });

            $(".personal-plan__modal__content .detail-section .field-type-text").each(function () {
                const inpField = $(this).find(".input-text");
                if ($(inpField).val().length) {
                    inpField.nextAll("label").addClass("focussed");
                }
            });

            $(".personal-plan__modal__content .detail-section input").on("focus", function () {
                if (!$(this).hasClass("error")) {
                    $(this).nextAll("label").addClass("focussed");
                }
            });

            $(".personal-plan__modal__content .detail-section input").on("blur", function () {
                blur_input_next(this);
            });

            function blur_input_next(y) {
                if (!$(y).hasClass("error")) {
                    if ($(y).val().length === 0 || $(y).val().length == null) {
                        $(y).nextAll("label").removeClass("focussed");
                    } else {
                        $(y).nextAll("label").addClass("focussed");
                    }
                }
            }

        });
    });
</script>